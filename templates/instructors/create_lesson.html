{% extends 'base.html' %}
{% load static %}

{% block content %}
  <h2>Create a New Lesson</h2>
  <form method="post" id="lesson-form">
    {% csrf_token %}
    
    <!-- Course (Select Input) -->
    <div class="form-group">
      <label for="id_course">Course:</label>
      {{ form.course }}
    </div>

    <!-- Module (Select Input) -->
    <div class="form-group">
      <label for="id_module">Module:</label>
      {{ form.module }}
    </div>

    <!-- Content (Text Area) -->
    <div class="form-group">
      <label for="id_content">Content:</label>
      {{ form.content }}
    </div>
    
    <button type="submit" class="btn btn-primary">Create Lesson</button>
  </form>

  <div id="lesson-data" style="display: none;">
    <!-- This will be used to load lesson data via AJAX -->
  </div>

  <a href="{% url 'instructors:create_assessment' %}" >Create lesson Assessment</a>

  <script>
    // JavaScript to update module options based on the selected course
    document.getElementById("id_course").addEventListener("change", function () {
      var courseId = this.value;
      var moduleSelect = document.getElementById("id_module");
      // Clear existing options
      moduleSelect.innerHTML = '<option value="" disabled selected>Select a module</option>';
      
      // Fetch modules associated with the selected course (you can use AJAX here)
      // For simplicity, you can pass a JSON object containing module data from your Django view
      var modules = JSON.parse('{{ module_data_json | safe }}');
      modules.forEach(function (module) {
        if (module.course_id == courseId) {
          var option = document.createElement("option");
          option.value = module.id;
          option.text = module.module_title;
          moduleSelect.appendChild(option);
        }
      });
    });

    // AJAX to save lesson data
    document.getElementById("lesson-form").addEventListener("submit", function (event) {
      event.preventDefault();
      var form = this;
      var formData = new FormData(form);

      fetch("{% url 'instructors:save_lesson_data' %}", {
        method: "POST",
        body: formData,
        headers: {
          "X-CSRFToken": "{{ csrf_token }}"
        }
      })
        .then(function (response) {
          if (response.status === 200) {
            alert("Lesson data saved successfully!");
          } else {
            alert("Error saving lesson data. Please try again.");
          }
        })
        .catch(function (error) {
          console.error("Error:", error);
        });
    });

    // AJAX to load lesson data
    document.getElementById("load-lesson-data").addEventListener("click", function () {
      fetch("{% url 'instructors:load_lesson_data' %}")
        .then(function (response) {
          if (response.status === 200) {
            return response.json();
          } else {
            alert("Error loading lesson data. Please try again.");
          }
        })
        .then(function (data) {
          // Populate the form fields with loaded data
          document.getElementById("id_course").value = data.course;
          document.getElementById("id_module").value = data.module;
          document.getElementById("id_content").value = data.content;
        })
        .catch(function (error) {
          console.error("Error:", error);
        });
    });
  </script>
{% endblock %}
